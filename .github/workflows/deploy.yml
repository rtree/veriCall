name: Deploy to Cloud Run

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: ${{ secrets.GCP_SERVICE_NAME }}
  REPOSITORY: ${{ secrets.GCP_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # GitHub Secrets â†’ GCP Secret Manager (å€‹åˆ¥ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã—ã¦)
      - name: Sync Secrets to Secret Manager
        run: |
          sync_secret() {
            local name=$1
            local value=$2
            if [ -z "$value" ]; then
              echo "âš ï¸ $name: å€¤ãŒç©ºã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
              return
            fi
            # æ”¹è¡Œã‚’é™¤åŽ»ã—ã¦ä¿å­˜
            local clean_value=$(printf '%s' "$value" | tr -d '\n\r')
            if gcloud secrets describe "$name" --project=${{ env.PROJECT_ID }} > /dev/null 2>&1; then
              printf '%s' "$clean_value" | gcloud secrets versions add "$name" --data-file=- --project=${{ env.PROJECT_ID }}
              echo "âœ… $name: æ›´æ–°"
            else
              printf '%s' "$clean_value" | gcloud secrets create "$name" --data-file=- --project=${{ env.PROJECT_ID }}
              echo "âœ… $name: ä½œæˆ"
            fi
          }
          
          echo "ðŸ” Secret Manager ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’åŒæœŸä¸­..."
          sync_secret "TWILIO_ACCOUNT_SID" "${{ secrets.TWILIO_ACCOUNT_SID }}"
          sync_secret "TWILIO_AUTH_TOKEN" "${{ secrets.TWILIO_AUTH_TOKEN }}"
          sync_secret "TWILIO_PHONE_NUMBER" "${{ secrets.TWILIO_PHONE_NUMBER }}"
          sync_secret "DESTINATION_PHONE_NUMBER" "${{ secrets.DESTINATION_PHONE_NUMBER }}"
          sync_secret "FORWARD_TIMEOUT" "${{ secrets.FORWARD_TIMEOUT }}"
          sync_secret "WHITELIST_NUMBERS" "${{ secrets.WHITELIST_NUMBERS }}"
          sync_secret "SENDGRID_API_KEY" "${{ secrets.SENDGRID_API_KEY }}"
          sync_secret "NOTIFICATION_EMAIL" "${{ secrets.NOTIFICATION_EMAIL }}"
          sync_secret "FROM_EMAIL" "${{ secrets.FROM_EMAIL }}"
          echo "âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåŒæœŸå®Œäº†"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Container
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:buildcache,mode=max

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars="NODE_ENV=production" \
            --set-secrets="TWILIO_ACCOUNT_SID=TWILIO_ACCOUNT_SID:latest,TWILIO_AUTH_TOKEN=TWILIO_AUTH_TOKEN:latest,TWILIO_PHONE_NUMBER=TWILIO_PHONE_NUMBER:latest,DESTINATION_PHONE_NUMBER=DESTINATION_PHONE_NUMBER:latest,FORWARD_TIMEOUT=FORWARD_TIMEOUT:latest,WHITELIST_NUMBERS=WHITELIST_NUMBERS:latest,SENDGRID_API_KEY=SENDGRID_API_KEY:latest,NOTIFICATION_EMAIL=NOTIFICATION_EMAIL:latest,FROM_EMAIL=FROM_EMAIL:latest" \
            --service-account ${{ env.PROJECT_NUMBER }}-compute@developer.gserviceaccount.com
          
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format='value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $URL"

      - name: Show Output
        run: |
          echo "ðŸš€ Deployment complete!"
          echo "   URL: ${{ steps.deploy.outputs.url }}"
          echo "   Twilio Webhook: ${{ steps.deploy.outputs.url }}/phone/incoming"

      - name: Get Logs on Failure
        if: failure()
        run: |
          echo "=== Fetching Cloud Run logs ==="
          gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --limit 50 \
            --format="table(timestamp, textPayload)" \
            --freshness=10m || echo "Failed to fetch logs"
